define(["lodash","moment","@grafana/data","app/plugins/sdk"],((e,t,r,i)=>(()=>{"use strict";let a={781:e=>{e.exports=r},347:e=>{e.exports=i},241:t=>{t.exports=e},468:e=>{e.exports=t}},n={};function s(e){let t=n[e];if(void 0!==t){return t.exports;}let r=n[e]={exports:{}};return a[e](r,r.exports,s),r.exports}s.n=e=>{let t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(let r in t){s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};let o={};return(()=>{s.r(o),s.d(o,{ConfigCtrl:()=>h,Datasource:()=>l,QueryCtrl:()=>c});let e=s(241),t=s.n(e),r=s(468),i=s.n(r),a=s(781);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class l{testDatasource(){return new Promise((function(e,t){e({status:"success",message:"Compare Query Source is working correctly",title:"Success"})}))}query(e){let r=this,i=t().groupBy(e.targets,(function(e){return void 0===e.datasource.uid?e.datasource:e.datasource.uid})),a=t().groupBy(e.targets,"refId"),n=[];return t().forEach(i,(function(i,s){let o=t().cloneDeep(e),l=r.datasourceSrv.get(s).then((function(t){if(t.meta.id===r.meta.id){return r._compareQuery(e,i,a,r);}{o.targets=i;let e=t.query(o);return"function"===typeof e.toPromise?e.toPromise():e}}));n.push(l)})),this.$q.all(n).then((function(e){return{data:t().flatten(t().filter(t().map(e,(function(e){let r=e.data;return r&&(r=t().filter(e.data,(function(e){return!0!==e.hide}))),r})),(function(e){return null!=e})))}}))}_compareQuery(e,r,i,n){let s=[];return t().forEach(r,(function(r){let o=r.query;if(null!==o&&""!==o&&null!==i[o]){let l=t().cloneDeep(i[o][0]);if(l.hide=!1,l){let u=l.datasource;r.timeShifts&&r.timeShifts.length>0&&t().forEach(r.timeShifts,(function(i){let o,f,c=i.aliasType||"suffix",d=i.delimiter||"_",h=n.datasourceSrv.get(u).then((function(r){if(r.meta.id===n.meta.id){return{data:[]};}if(o=n.templateSrv.replace(i.value,e.scopedVars),f=n.templateSrv.replace(i.alias,e.scopedVars)||o,null===o||""===o||void 0===o){return{data:[]};}let a=t().cloneDeep(e);a.range.from=n.addTimeShift(a.range.from,o),a.range.to=n.addTimeShift(a.range.to,o),a.range.raw={from:a.range.from,to:a.range.to},a.rangeRaw=a.range.raw,l.refId=l.refId+"_"+o,a.targets=[l],a.requestId=a.requestId+"_"+o;let s=r.query(a);return"function"===typeof s.toPromise?s.toPromise():s})).then((function(e){let t=e.data;return t.forEach((function(e){if(e.target){e.target=n.generalAlias(e.target,f,c,d),void 0!==e.title&&null!==e.title&&(e.title=n.generalAlias(e.title,f,c,d));}else if(e.fields){e.fields.forEach((function(e){e.name&&(e.name=n.generalAlias(e.name,f,c,d)),e.config&&e.config.displayName&&(e.config.displayName=n.generalAlias(e.config.displayName,f,c,d)),e.config&&e.config.displayNameFromDS&&(e.config.displayNameFromDS=n.generalAlias(e.config.displayNameFromDS,f,c,d))}));}else if(e.columns){for(let t=1;t<e.columns.length;t++){let r=e.columns[t];r.text&&(r.text=n.generalAlias(r.text,f,c,d))}}if(r.process){let t=n.parseShiftToMs(o);if("table"===e.type){e.rows&&e.rows.forEach((function(e){e[0]=e[0]+t}));}else if(e.datapoints){e.datapoints.forEach((function(e){e[1]=e[1]+t}));}else if(e.fields&&e.fields.length>0){const r=e.fields.find((e=>"time"===e.type));if(r){const i={name:r.name,type:r.type,config:r.config||{},labels:r.labels,values:new a.ArrayVector()};for(let a=0;a<e.length;a++){i.values.set(a,r.values.get(a)+t);}e.fields[0]=i}}}e.hide=r.hide})),{data:t}}));s.push(h)}))}}})),this.$q.all(s).then((function(e){return{data:t().flatten(t().filter(t().map(e,(function(e){let r=e.data;return r&&(r=t().filter(e.data,(function(e){return!0!==e.hide}))),r})),(function(e){return null!=e})))}}))}generalAlias(e,t,r,i){switch(r){case"prefix":return t+i+e;case"absolute":return t;default:return e+i+t}}parseShiftToMs(e){let r=this.parseTimeShift(e);if(r){let a=0-r.num,n=r.unit;if(t().includes(this.units,n)){let e=i()(),t=e.clone().add(a,n);return e.valueOf()-t.valueOf()}}}parseTimeShift(e){for(var t=e,r=e.length,i=0;i<r&&!isNaN(t.charAt(i));){if(++i>10){return;}}return{num:parseInt(t.substring(0,i),10),unit:t.charAt(i)}}addTimeShift(e,r){let i=this.parseTimeShift(r);if(i){let a=0-i.num,n=i.unit;if(t().includes(this.units,n)){return e.clone().add(a,n)}}}constructor(e,t,r){n(this,"datasourceSrv",void 0),n(this,"$q",void 0),n(this,"templateSrv",void 0),n(this,"meta",void 0),n(this,"units",["y","M","w","d","h","m","s"]),this.datasourceSrv=t,this.$q=e,this.templateSrv=r}}let u=s(347);function f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class c extends u.QueryCtrl{targetBlur(){this.refresh()}onChangeInternal(){this.refresh()}addTimeShifts(){let e=this.getTimeShiftId();this.target.timeShifts.push({id:e})}removeTimeShift(e){if(!(this.target.timeShifts&&this.target.timeShifts.length<=1)){let r=t().indexOf(this.target.timeShifts,e);this.target.timeShifts.splice(r,1),this.refreshTimeShifts()}}refreshTimeShifts(){this.refresh()}onAliasAsChange(e){console.error("timeShift.aliasAs="+this.target.aliasAs),console.error("aliasAs="+e)}getTimeShiftId(){let e=0;for(;;){if(t().every(this.target.timeShifts,(function(t){return t.id!==e}))){return e;}e++}}constructor(e,t){super(e,t),f(this,"errors",void 0),f(this,"query",void 0),f(this,"target",void 0),f(this,"aliasTypes",["suffix","prefix","absolute"]),this.target.timeShifts||(this.target.timeShifts=[]),0===this.target.timeShifts.length&&this.addTimeShifts(),void 0===this.target.process&&(this.target.process=!0)}}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}f(c,"templateUrl","partials/query.editor.html");class h{constructor(){d(this,"current",void 0)}}d(h,"templateUrl","partials/config.html")})(),o})()));
//# sourceMappingURL=module.js.map
